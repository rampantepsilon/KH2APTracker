<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Kingdom Hearts 2 Archipelago Item Tracker</title>
    <link rel="stylesheet" href="style.css">
    <script src="logic.js"></script>
</head>

<body>
    <audio id="lEmblem">
        <source src="audio/Enter.mp3" type="audio/mpeg">
    </audio>
    <audio id="bounty">
        <source src="audio/bounty.ogg" type="audio/ogg">
    </audio>
    <table style="height: 97vh">
        <!-- Items Start-->
        <tr>
            <td style="height:45px; text-align: center;" colspan="2">
                <table width="663px" style="background-color: rgba(0,0,0,0.5);">
                    <tr>
                        <td id="jumpNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="highjump" style='opacity: 0.3'
                                src="img/simple/movement/highjump.png">
                        </td>
                        <td id="runNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="quickrun" style='opacity: 0.3'
                                src="img/simple/movement/quickrun.png">
                        </td>
                        <td id="dodgeNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="dodgeroll" style='opacity: 0.3'
                                src="img/simple/movement/dodgeroll.png">
                        </td>
                        <td id="aerialNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="aerialdodge" style='opacity: 0.3'
                                src="img/simple/movement/aerialdodge.png">
                        </td>
                        <td id="glideNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="glide" style='opacity: 0.3'
                                src="img/simple/movement/glide.png">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td style="height:45px; text-align: center;" colspan="2">
                <table style="background-color: rgba(0,0,0,0.5);">
                    <tr>
                        <td id="fireNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="fire" style='opacity: 0.3' src="img/simple/magic_fire.png">
                        </td>
                        <td id="blizzardNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="blizzard" style='opacity: 0.3'
                                src="img/simple/magic_blizzard.png">
                        </td>
                        <td id="thunderNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="thunder" style='opacity: 0.3'
                                src="img/simple/magic_thunder.png">
                        </td>
                        <td id="cureNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="cure" style='opacity: 0.3' src="img/simple/magic_cure.png">
                        </td>
                        <td id="reflectNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="reflect" style='opacity: 0.3'
                                src="img/simple/magic_reflect.png">
                        </td>
                        <td id="magnetNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="magnet" style='opacity: 0.3'
                                src="img/simple/magic_magnet.png">
                        </td>
                        <td id="pageNum" class="trackerNum">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="tornpage" style='opacity: 0.3'
                                src="img/simple/unlocks/torn_pages.png">
                        </td>
                        <td id="emblemNum" class="trackerNum" style="width: 60px; text-align: right;">
                            0
                        </td>
                        <td>
                            <img class='magic images' id="emblem" style='opacity: 0.3' src="img/simple/emblem.png">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td style="height:45px; text-align: center;" colspan="2">
                <table style="background-color: rgba(0,0,0,0.5);">
                    <tr>
                        <td>
                            <img class='forms images' id='valor' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/form_valor.png">
                        </td>
                        <td>
                            <img class='forms images' id='wisdom' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/form_wisdom.png">
                        </td>
                        <td>
                            <img class='forms images' id='limit' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/form_limit.png">
                        </td>
                        <td>
                            <img class='forms images' id='master' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/form_master.png">
                        </td>
                        <td>
                            <img class='forms images' id='final' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/form_final.png">
                        </td>
                        <td>
                            <img class='forms images' id='chickenlittle' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/summon_chicken_little.png">
                        </td>
                        <td>
                            <img class='forms images' id='genie' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/summon_genie.png">
                        </td>
                        <td>
                            <img class='forms images' id='stitch' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/summon_stitch.png">
                        </td>
                        <td>
                            <img class='forms images' id='peterpan' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/summon_peter_pan.png">
                        </td>
                        <td>
                            <img class='forms images' id='oncemore' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/once_more.png">
                        </td>
                        <td>
                            <img class='forms images' id='secondchance' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/second_chance.png">
                        </td>
                        <td>
                            <img class='forms images' id='connection' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/proof_connection.png">
                        </td>
                        <td>
                            <img class='forms images' id='nonexistence' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/proof_nonexistence.png">
                        </td>
                        <td>
                            <img class='forms images' id='peace' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/proof_peace.png">
                        </td>
                        <td>
                            <img class='forms images' id='promisecharm' style='opacity: 0.3' style='opacity: 0.3'
                                src="img/simple/promise_charm.png">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td style="height:45px; text-align: center;" colspan="2">
                <table width='663px' style="background-color: rgba(0,0,0,0.5);">
                    <tr>
                        <td id="beastNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='beastclaw' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_beastclaw.png" title="Beast's Claw">
                        </td>
                        <td id="boneNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='bonefist' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_bonefist.png" title="Bone Fist">
                        </td>
                        <td id="proudNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='proudfang' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_proudfang.png" title="Proud Fang">
                        </td>
                        <td id="warNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='battlefieldsofwar' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_battlefieldsofwar.png" title="Battlefields of War">
                        </td>
                        <td id="swordNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='ancestorsword' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_ancestorsword.png" title="Sword of the Ancestor">
                        </td>
                        <td id="skillNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='skillcrossbones' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_skillcrossbones.png" title="Skill and Crossbones">
                        </td>
                        <td id="scimitarNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='scimitar' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_scimitar.png" title="Scimitar">
                        </td>
                        <td id="diskNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='identitydisk' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_identitydisk.png" title="Identity Disk">
                        </td>
                        <td id="cardNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='membershipcard' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_membershipcard.png" title="Membership Card">
                        </td>
                        <td id="sketchesNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='picture' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_picture.png" title="Namine's Sketch">
                        </td>
                        <td id="icecreamNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='icecream' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_icecream.png" title="Ice Cream">
                        </td>
                        <td id="castleNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='disneycastlekey' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_disneycastlekey.png" title="Disney Castle Key">
                        </td>
                        <td id="dawnNum" class="unlockNum">
                            0
                        </td>
                        <td>
                            <img class='unlocks images' id='waytothedawn' style='opacity: 0.3'
                                src="img/simple/unlocks/lock_waytothedawn.png" title="Way to the Dawn">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <!--Items End-->
        <!--Level Tracking Start-->
        <tr>
            <td colspan="2">
                <table width="663px" style="background-color: rgba(0,0,0,0.5);">
                    <tr>
                        <td>
                            <div id="valorLvl" style="text-align: right;">0</div>
                        </td>
                        <td>
                            <img src="img/simple/form_valor.png" class='forms images'>
                        </td>
                        <td>
                            <div id="wisdomLvl" style="text-align: right;">0</div>
                        </td>
                        <td>
                            <img src="img/simple/form_wisdom.png" class='forms images'>
                        </td>
                        <td>
                            <div id="limitLvl" style="text-align: right;">0</div>
                        </td>
                        <td>
                            <img src="img/simple/form_limit.png" class='forms images'>
                        </td>
                        <td>
                            <div id="masterLvl" style="text-align: right;">0</div>
                        </td>
                        <td>
                            <img src="img/simple/form_master.png" class='forms images'>
                        </td>
                        <td>
                            <div id="finalLvl" style="text-align: right;">0</div>
                        </td>
                        <td>
                            <img src="img/simple/form_final.png" class='forms images'>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <!--Level Tracking End-->
        <!--Worlds Start-->
        <tr>
            <td colspan="2">
                <table id="worldsTable" width='663px' style="background-color: rgba(0,0,0,0.5);">
                    <tr>
                        <td style="text-align: center; width: 100px">
                            World
                        </td>
                        <td style="text-align: center; width: 30px" colspan="2">
                            Locks Remaining
                        </td>
                        <td style="text-align: center; width: 100px">
                            World
                        </td>
                        <td style="text-align: center; width: 30px" colspan="2">
                            Locks Remaining
                        </td>
                        <td align="center" rowspan="8" style="vertical-align: top; width: 180px;">
                            <div id='emblemTitle'>Required<br>Emblems:</div>
                            <div style="text-align: center;" id="emblemCount">0</div>
                            <br>
                            <div id='bountyTitle'>Required<br>Bounties:</div>
                            <div style="text-align: center;" id="bountyCount">0</div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/stt.png">
                        </td>
                        <td id="sttCount" class="worldRem">
                            1
                        </td>
                        <td>/ 1</td>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/tt.png">
                        </td>
                        <td id="ttCount" class="worldRem">
                            3
                        </td>
                        <td>/ 3</td>
                    </tr>
                    <tr>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/hb.png">
                        </td>
                        <td id="hbCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/bc.png">
                        </td>
                        <td id="bcCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                    </tr>
                    <tr>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/oc.png">
                        </td>
                        <td id="ocCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/agra.png">
                        </td>
                        <td id="agraCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                    </tr>
                    <tr>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/lod.png">
                        </td>
                        <td id="lodCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/100a.png">
                        </td>
                        <td id="100aCount" class="worldRem">
                            5
                        </td>
                        <td>/ 5</td>
                    </tr>
                    <tr>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/pl.png">
                        </td>
                        <td id="plCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/dc.png">
                        </td>
                        <td id="dcCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                    </tr>
                    <tr>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/ht.png">
                        </td>
                        <td id="htCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/pr.png">
                        </td>
                        <td id="prCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                    </tr>
                    <tr>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/sp.png">
                        </td>
                        <td id="spCount" class="worldRem">
                            2
                        </td>
                        <td>/ 2</td>
                        <td>
                            <img class="worldTracker images" src="img/simple/worlds/twtnw.png">
                        </td>
                        <td id="twtnwCount" class="worldRem">
                            1
                        </td>
                        <td>/ 1</td>
                    </tr>
                </table>
            </td>
        </tr>
        <!--Worlds End-->
        <tr>
            <td colspan="2" align="center">
                <span id="images">
                    <input type="radio" id="simple" name="images" checked><label for='simple'>Simple Icons</label>
                    <input type="radio" id="detailed" name="images"><label for='detailed'>Detailed Icons</label>
                </span>
                <input type="checkbox" id="background"><label for='background'>Background?</label>
            </td>
        </tr>
        <tr>
            <td style="vertical-align: bottom; width: calc(100% - 300px)">
                <div id="log"></div>
            </td>
            <td style="text-align: center; vertical-align: bottom;">
                <button class="connButton" onclick="save()">Save Form Levels</button>
                <button class="connButton" onclick="load()">Load Form Levels</button>
                <button class="connButton" onclick="disconnect()">Disconnect</button><br>
                <br>
                <select class="connButton" id="winCon" onchange="winCon()">
                    <option value="Lucky">Lucky Emblems</option>
                    <option value="Bounty">Bounty</option>
                    <option value="Proof">Three Proofs</option>
                </select>
            </td>
        </tr>
    </table>
    <script>
        document.getElementById('bountyTitle').style.display = 'none';
        document.getElementById('bountyCount').style.display = 'none';
        var backgroundVar = 0;

        document.getElementById('images').addEventListener('change', function (e) {
            let target = e.target;
            switch (target.id) {
                case ('simple'):
                    for (i in document.getElementsByClassName('images')) {
                        document.getElementsByClassName('images')[i].src = document.getElementsByClassName('images')[i].src.replace('detailed', 'simple');
                    }
                    break;
                case ('detailed'):
                    for (i in document.getElementsByClassName('images')) {
                        document.getElementsByClassName('images')[i].src = document.getElementsByClassName('images')[i].src.replace('simple', 'detailed');
                    }
                    break;
            }
        })

        document.getElementById('background').addEventListener('change', function (e) {
            let target = e.target;
            switch (target.id) {
                case 'background':
                    if (backgroundVar == 0) {
                        document.body.style.backgroundImage = 'url("img/background0.png")'
                        document.body.style.backgroundSize = 'auto 1000px'
                        backgroundVar = 1;
                    } else {
                        document.body.style.backgroundImage = 'none';
                        backgroundVar = 0;
                    }
                    break;
            }
        })

        function winCon() {
            var x = document.getElementById('winCon').value;
            if (x == 'Lucky') {
                document.getElementById('bountyTitle').style.display = 'none';
                document.getElementById('bountyCount').style.display = 'none';
                document.getElementById('emblemTitle').style.display = 'block';
                document.getElementById('emblemCount').style.display = 'block';
            }
            if (x == 'Bounty') {
                document.getElementById('bountyTitle').style.display = 'block';
                document.getElementById('bountyCount').style.display = 'block';
                document.getElementById('emblemTitle').style.display = 'none';
                document.getElementById('emblemCount').style.display = 'none';
            }
            if (x == 'Proof') {
                document.getElementById('emblemTitle').style.display = 'none';
                document.getElementById('emblemCount').style.display = 'none';
                document.getElementById('bountyTitle').style.display = 'none';
                document.getElementById('bountyCount').style.display = 'none';
            }
        }

        function save() {
            localStorage.setItem('formLvl', [document.getElementById('valorLvl').innerHTML, document.getElementById('wisdomLvl').innerHTML, document.getElementById('limitLvl').innerHTML, document.getElementById('masterLvl').innerHTML, document.getElementById('finalLvl').innerHTML])
        }

        function load() {
            var formLevels = localStorage.getItem('formLvl').split(',');
            var formIDs = ['valorLvl', 'wisdomLvl', 'limitLvl', 'masterLvl', 'finalLvl']
            for (i in formLevels) {
                document.getElementById(formIDs[i]).innerHTML = formLevels[i];
            }

            if (document.getElementById('final').style.opacity != '1') {
                if (formLevels[4] > 0) {
                    markChecks("Final Form");
                }
            }
        }

        function disconnect() {
            sessionStorage.setItem('host', "");
            sessionStorage.setItem('port', '');
            sessionStorage.setItem('game', '');
            sessionStorage.setItem('player', '');

            window.location.href = './server.html'
        }
    </script>
    <script type="module">
        import {
            Client,
            ITEMS_HANDLING_FLAGS,
            SERVER_PACKET_TYPE,
        } from "https://unpkg.com/archipelago.js@1.0.0/dist/archipelago.js";

        // Create a new Archipelago client
        const client = new Client();

        const connectionInfo = {
            hostname: sessionStorage.getItem('host'), // Replace with the actual AP server hostname.
            port: parseInt(sessionStorage.getItem('port')), // Replace with the actual AP server port.
            game: sessionStorage.getItem('game'), // Replace with the game name for this player.
            name: sessionStorage.getItem('player'), // Replace with the player slot name.
            items_handling: ITEMS_HANDLING_FLAGS.REMOTE_ALL,
        };

        // Set up event listeners
        client.addListener(SERVER_PACKET_TYPE.CONNECTED, (packet) => {
            console.log("Connected to server: ", packet);
            document.getElementById('emblemCount').innerHTML = packet['slot_data']["LuckyEmblemsRequired"];
            document.getElementById('bountyCount').innerHTML = packet['slot_data']["BountyRequired"];
        });

        var itemLog = [];

        client.addListener(SERVER_PACKET_TYPE.RECEIVED_ITEMS, (packet) => {
            console.log(packet.items)
            var packetItems = packet.items;
            var receivedItems = []

            for (var i = 0; i < packetItems.length; i++) {
                receivedItems.push(client.items.name("Kingdom Hearts 2", packetItems[i]['item']));
            }

            itemLog = receivedItems;

            for (var j = 0; j < receivedItems.length; j++) {
                markChecks(receivedItems[j]);
            }
        })

        client.addListener(SERVER_PACKET_TYPE.PRINT_JSON, (packet, message) => {
            var oldmsg = document.getElementById('log').innerHTML;
            document.getElementById('log').innerHTML = "<li>" + message + "</li>" + oldmsg;

            if (!itemLog.includes('Final Form')) {
                if (message.indexOf('(Edge of Ultima Slot)') != -1) {
                    if (message.indexOf(sessionStorage.getItem('player')) != -1) {
                        markChecks("Final Form");
                    }
                }
            }

            var playerName = sessionStorage.getItem('player');


            if (message.indexOf(playerName) == 0) {
                if (message.indexOf('(Valor level') != -1) {
                    document.getElementById('valorLvl').innerHTML = message.substring((message.indexOf('(Valor level') + 12), (message.indexOf('(Valor level') + 14));
                }
                if (message.indexOf('(Wisdom level') != -1) {
                    document.getElementById('wisdomLvl').innerHTML = message.substring((message.indexOf('(Wisdom level') + 13), (message.indexOf('(Wisdom level') + 15));
                }
                if (message.indexOf('(Limit level') != -1) {
                    document.getElementById('limitLvl').innerHTML = message.substring((message.indexOf('(Limit level') + 12), (message.indexOf('(Limit level') + 14));
                }
                if (message.indexOf('(Master level') != -1) {
                    document.getElementById('masterLvl').innerHTML = message.substring((message.indexOf('(Master level') + 13), (message.indexOf('(Master level') + 15));
                }
                if (message.indexOf('(Final level') != -1) {
                    document.getElementById('finalLvl').innerHTML = message.substring((message.indexOf('(Final level') + 12), (message.indexOf('(Final level') + 14));
                }
            }
        });

        // Connect to the Archipelago server
        client
            .connect(connectionInfo)
            .then(() => {
                console.log("Connected to the server");
                // You are now connected and authenticated to the server. You can add more code here if need be.
            })
            .catch((error) => {
                console.error("Failed to connect:", error);
                // Handle the connection error.
            });

        // Disconnect from the server when unloading window.
        window.addEventListener("beforeunload", () => {
            client.disconnect();
        });
    </script>
</body>

</html>